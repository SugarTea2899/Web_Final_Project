<!doctype html>
<html lang="zxx">

<head>
    <% include ../header.ejs %>
</head>

<body>
    <%- include('../main-menu.ejs', {isAuthenticated: isAuthenticated, username: username}) %>
    <!-- Header part end-->

    <!-- banner part start-->
    <section class="banner_part">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-7">
                    <div class="banner_slider">
                        <div class="single_banner_slider">
                            <div class="banner_text">
                                <div class="banner_text_iner">
                                    <h5>Thời Trang Mùa Đông</h5>
                                    <h1>Bộ Sưu Tập 2019</h1>
                                    <a href="/category" class="btn_1">mua ngay</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- banner part start-->

    <!-- feature_part start-->
    <section class="feature_part pt-4">
        <div class="container-fluid p-lg-0 overflow-hidden">
            <div class="row align-items-center justify-content-between">
                <div class="col-lg-4 col-sm-6">
                    <div class="single_feature_post_text">
                        <img src="img/feature_1.png" alt="#">
                        <div class="hover_text">
                            <a href="/category" class="btn_2">thời trang nam </a>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 col-sm-6">
                    <div class="single_feature_post_text">
                        <img src="img/feature_2.png" alt="#">
                        <div class="hover_text">
                            <a href="/category" class="btn_2">thời trang nữ</a>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 col-sm-6">
                    <div class="single_feature_post_text">
                        <img src="img/feature_3.png" alt="#">
                        <div class="hover_text">
                            <a href="/single-product" class="btn_2">Phụ kiện</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- upcoming_event part start-->

    <!-- new arrival part here -->
    <section class="new_arrival section_padding">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <div class="arrival_tittle">
                        <h2>Mẫu mới cập nhật</h2>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="arrival_filter_item filters">
                        <ul>
                            <li class="active controls" data-filter="*">Tất cả</li>
                            <li class="controls" data-toggle=".men">nam</li>
                            <li class="controls" data-toggle=".women">nữ</li>
                            <li class="controls" data-toggle=".shoes">giày</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row">
                <div class="col-lg-12">
                    <div class="new_arrival_iner filter-container">
                        <div class="single_arrivel_item weidth_1 mix shoes">
                            <img src="img/arrivel/arrivel_5.png" alt="#">
                            <div class="hover_text">
                                <p>Canvas</p>
                                <a href="/category/product01">
                                    <h3>Lorem Canvas Low-Top Sneaker</h3>
                                </a>
                                <div class="rate_icon">
                                    <a href="#"> <i class="fas fa-star"></i> </a>
                                    <a href="#"> <i class="fas fa-star"></i> </a>
                                    <a href="#"> <i class="fas fa-star"></i> </a>
                                    <a href="#"> <i class="fas fa-star"></i> </a>
                                    <a href="#"> <i class="fas fa-star"></i> </a>
                                </div>
                                <h5>$150</h5>
                                <div class="social_icon">
                                    <a href="#"><i class="ti-heart"></i></a>
                                    <a href="#"><i class="ti-bag"></i></a>
                                </div>
                            </div>
                        </div>
                        <div class="single_arrivel_item weidth_2 mix women">
                            <img src="img/arrivel/arrivel_2.png" alt="#">
                            <div class="hover_text">
                                <p>Canvas</p>
                                <a href="/category/product01">
                                    <h3>Lorem Canvas Low-Top Sneaker</h3>
                                </a>
                                <div class="rate_icon">
                                    <a href="#"> <i class="fas fa-star"></i> </a>
                                    <a href="#"> <i class="fas fa-star"></i> </a>
                                    <a href="#"> <i class="fas fa-star"></i> </a>
                                    <a href="#"> <i class="fas fa-star"></i> </a>
                                    <a href="#"> <i class="fas fa-star"></i> </a>
                                </div>
                                <h5>$150</h5>
                                <div class="social_icon">
                                    <a href="#"><i class="ti-heart"></i></a>
                                    <a href="#"><i class="ti-bag"></i></a>
                                </div>
                            </div>
                        </div>
                        <div class="single_arrivel_item weidth_3 mix shoes women">
                            <img src="img/arrivel/arrivel_3.png" alt="#">
                            <div class="hover_text">
                                <p>Canvas</p>
                                <a href="/category/product01">
                                    <h3>Lorem Canvas Low-Top Sneaker</h3>
                                </a>
                                <div class="rate_icon">
                                    <a href="#"> <i class="fas fa-star"></i> </a>
                                    <a href="#"> <i class="fas fa-star"></i> </a>
                                    <a href="#"> <i class="fas fa-star"></i> </a>
                                    <a href="#"> <i class="fas fa-star"></i> </a>
                                    <a href="#"> <i class="fas fa-star"></i> </a>
                                </div>
                                <h5>$150</h5>
                                <div class="social_icon">
                                    <a href="#"><i class="ti-heart"></i></a>
                                    <a href="#"><i class="ti-bag"></i></a>
                                </div>
                            </div>
                        </div>
                        <div class="single_arrivel_item weidth_3 mix women men">
                            <img src="img/arrivel/arrivel_4.png" alt="#">
                            <div class="hover_text">
                                <p>Canvas</p>
                                <a href="/category/product01">
                                    <h3>Lorem Canvas Low-Top Sneaker</h3>
                                </a>
                                <div class="rate_icon">
                                    <a href="#"> <i class="fas fa-star"></i> </a>
                                    <a href="#"> <i class="fas fa-star"></i> </a>
                                    <a href="#"> <i class="fas fa-star"></i> </a>
                                    <a href="#"> <i class="fas fa-star"></i> </a>
                                    <a href="#"> <i class="fas fa-star"></i> </a>
                                </div>
                                <h5>$150</h5>
                                <div class="social_icon">
                                    <a href="#"><i class="ti-heart"></i></a>
                                    <a href="#"><i class="ti-bag"></i></a>
                                </div>
                            </div>
                        </div>
                        <div class="single_arrivel_item weidth_2 mix men women">
                            <img src="img/arrivel/arrivel_1.png" alt="#">
                            <div class="hover_text">
                                <p>Canvas</p>
                                <a href="/category/product01">
                                    <h3>Lorem Canvas Low-Top Sneaker</h3>
                                </a>
                                <div class="rate_icon">
                                    <a href="#"> <i class="fas fa-star"></i> </a>
                                    <a href="#"> <i class="fas fa-star"></i> </a>
                                    <a href="#"> <i class="fas fa-star"></i> </a>
                                    <a href="#"> <i class="fas fa-star"></i> </a>
                                    <a href="#"> <i class="fas fa-star"></i> </a>
                                </div>
                                <h5>$150</h5>
                                <div class="social_icon">
                                    <a href="#"><i class="ti-heart"></i></a>
                                    <a href="#"><i class="ti-bag"></i></a>
                                </div>
                            </div>
                        </div>
                        <div class="single_arrivel_item weidth_1 mix shoes men">
                            <img src="img/arrivel/arrivel_6.png" alt="#">
                            <div class="hover_text">
                                <p>Canvas</p>
                                <a href="/category/product01">
                                    <h3>Lorem Canvas Low-Top Sneaker</h3>
                                </a>
                                <div class="rate_icon">
                                    <a href="#"> <i class="fas fa-star"></i> </a>
                                    <a href="#"> <i class="fas fa-star"></i> </a>
                                    <a href="#"> <i class="fas fa-star"></i> </a>
                                    <a href="#"> <i class="fas fa-star"></i> </a>
                                    <a href="#"> <i class="fas fa-star"></i> </a>
                                </div>
                                <h5>$150</h5>
                                <div class="social_icon">
                                    <a href="#"><i class="ti-heart"></i></a>
                                    <a href="#"><i class="ti-bag"></i></a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- new arrival part end -->

    <% include ../footer.ejs %>
    <% include ../script.ejs %>

    <script>
        const LINK_API = 'http://localhost:3000/api/';
        <% if (isAuthenticated) {%>
            const id = "<%= id%>";
            window.localStorage.setItem("userId", id);
            let isLoaded = window.localStorage.getItem("isLoaded");
            if (isLoaded != "true"){
                appendCartList(id);
                window.localStorage.setItem("isLoaded", "true");
            }       
        <% } %>
        
        
        async function appendCartList(userId){
            const response = await fetch(LINK_API + 'user-cart?userId=' + userId);
            const data = await response.json();
            const cartListString = window.localStorage.getItem("cartList");
            let cartList = [];
            if (cartListString != "" && cartListString != null){
                cartList = JSON.parse(cartListString);

                data.forEach((item) => {
                    let index = findIndex(item.product, cartList);
                    if (index == -1)
                        cartList.push(item);
                    else{
                        cartList[index].quantity += item.quantity;
                    }
                });
                window.localStorage.setItem("cartList", JSON.stringify(cartList));
                let size = 0;
                cartList.forEach((item) => {
                    size += item.quantity;
                    addItemToUserCart(userId, item.product._id, item.quantity, item.totalPrice);
                });
                changeCartSize(size);
            }
            else{
                window.localStorage.setItem("cartList", JSON.stringify(data));
                let size = 0;
                data.forEach((item) => {
                    size += item.quantity;
                });
                changeCartSize(size);
            }

        }

        function changeCartSize(size){
            const cartSize = document.getElementById('cart-size');
            cartSize.innerText = size;
            window.localStorage.setItem("cartSize", size);
        }

        function findIndex(product, cartList){
            let res = -1;
            for (i = 0; i < cartList.length; i++){
                if (product._id == cartList[i].product._id)
                {
                    res = i;
                    return res;
                }
            }
            return res;
        }

        async function addItemToUserCart(userId, productId, quantity, totalPrice){
            const data = {userId: userId, productId: productId, quantity: quantity, totalPrice: totalPrice};
            await fetch(LINK_API + 'update-cart',{
                method: 'POST',
                headers:{
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
        }
    </script>
    
</body>

</html>